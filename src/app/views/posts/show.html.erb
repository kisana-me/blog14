<% keywords = @post.tags.pluck(:name).join(', ') %>
<% provide(:title, @post.title) %>
<% provide(:author,  @post.account.name) %>
<% provide(:author_id, @post.account.aid) %>
<% provide(:description, @post.summary) %>
<% provide(:keywords, keywords) %>
<% provide(:robots, @post.opened? ? '' : 'false') %>
<% provide(:type, 'article') %>
<% provide(:image, @post.thumbnail_url) %>
<% provide(:card, 'summary_large_image') %>
<% provide(:alt, @post.title) %>
<% provide(:layout_style, 'full') %>

<div class="post">
  <% if @is_post_owner %>
    <div class="post-owners-info">
      <div class="post-owners-message">あなたはこの記事の管理者です</div>
      <div>公開状況: <%= t("activerecord.enums.post.visibility.#{@post.visibility}") %></div>
      <div>閲覧数: <%= @views_count %></div>
      <div>旧閲覧数: <%= @post.meta.fetch("views_count", 0) %></div>
      <div>合計閲覧数: <%= @views_count.to_i + @post.meta.fetch("views_count", 0).to_i %></div>
      <div>公開コメント数: <%= @post.comments.where(visibility: :opened).count %></div>
      <div>合計コメント数: <%= @post.comments.count %></div>
      <div><%= link_to('編集', edit_post_path(@post.name_id), data: { turbo: false }, method: :get) %></div>
    </div>
  <% end %>

  <div class="post-thumbnail">
    <%= image_tag @post.thumbnail_url, alt: "#{@post.title}のサムネイル" %>
  </div>

  <div class="post-context">
    <h1 class="post-title"><%= @post.title.present? ? @post.title : 'タイトルなし' %></h1>
    <div class="post-summary"><%= @post.summary %></div>

    <div class="post-dates">
      <% if @post.published_at %>
        <div>
          公開:
          <time datetime="<%= @post.published_at %>" itemprop="datepublished">
            <%= @post.published_at.strftime('%Y/%m/%d %H:%M') %>
          </time>
        </div>
      <% end %>
      <% if @post.edited_at %>
        <div>
          更新:
          <time datetime="<%= @post.edited_at %>" itemprop="datemodified">
            <%= @post.edited_at.strftime('%Y/%m/%d %H:%M') %>
          </time>
        </div>
      <% end %>
      <% if @post.published_at.nil? && @post.edited_at.nil? %>
        <div>
          公開/更新日時無し
        </div>
      <% end %>
    </div>

    <div class="post-account">
      <%= link_to account_path(@post.account.name_id), class: 'post-account-path' do %>
        <div class="post-account-top">
          <div class="post-account-icon-container">
            <%= image_tag(@post.account.icon_url, class: 'post-account-icon', alt: "#{@post.account.name}のアイコン") %>
          </div>
          <div class="post-account-name">
            <%= @post.account.name %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="post-tags">
      <% @post.tags.each do |tag| %>
        <%= link_to(tag.name, tag_path(tag.name_id), class: 'post-tag') %>
      <% end %>
    </div>

    <div class="post-meta">
      <a href="https://x.com/intent/post?text=<%= URI.encode_www_form_component(full_title(@post.title)) %>&url=<%= full_url("/posts/#{@post.aid}") %>" class="x-share-button" target="_blank">Xに共有</a>
      <a href="https://misskey-hub.net/share?text=<%= URI.encode_www_form_component(full_title(@post.title)) %>&url=<%= full_url("/posts/#{@post.aid}") %>" class="misskey-share-button" target="_blank">Misskeyに共有</a>
    </div>
  </div>

  <div class="post-toc">
    <span>目次</span>
    <% toc = md_render_toc @post.content %>
    <% if toc.present? %>
      <%= toc %>
    <% else %>
      <p>目次はありません</p>
    <% end %>
  </div>

  <div class="post-content">
    <%= md_render @post.content %>
  </div>

  <div class="post-ending">
    <hr class="post-hr"/>
    <div class="post-meta">
      <a href="https://x.com/intent/post?text=<%= URI.encode_www_form_component(full_title(@post.title)) %>&url=<%= full_url("/posts/#{@post.aid}") %>" class="x-share-button" target="_blank">Xに共有</a>
      <a href="https://misskey-hub.net/share?text=<%= URI.encode_www_form_component(full_title(@post.title)) %>&url=<%= full_url("/posts/#{@post.aid}") %>" class="misskey-share-button" target="_blank">Misskeyに共有</a>
    </div>
  </div>

  <div class="post-comments">
    <details>
      <summary>コメントを残す</summary>
      <%= render 'comments/form', comment: Comment.new, url: comments_path, post_aid: @post.aid %>
    </details>
    <%= render 'comments/comments', post: @post %>
  </div>
</div>
